<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Acompanhamento — Final (rev)</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--soft:#1a2230;--text:#e6edf3;--muted:#9fb0c8;--accent:#3aa6ff;--br:16px}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .login{max-width:360px;margin:10vh auto;background:var(--card);padding:24px;border-radius:var(--br);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .f{display:flex;flex-direction:column;gap:10px}
    .f label{font-size:12px;color:var(--muted)}
    .f input{background:var(--soft);border:1px solid #263247;color:var(--text);padding:10px;border-radius:10px}
    .btn{background:var(--accent);border:0;color:#00111f;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .err{color:#ff453a;font-size:12px;min-height:16px}
    .app{display:none}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:520px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);padding:16px;border-radius:var(--br)}
    .card .k{font-size:12px;color:var(--muted)}
    .card .v{font-size:20px;font-weight:800;margin-top:4px}
    .highlight{border:1px solid #263247}
    .muted{color:var(--muted);font-size:12px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:14px 0}
    .pill{background:var(--soft);border:1px solid #22304a;padding:6px 10px;border-radius:999px;color:var(--muted);cursor:pointer}
    .pill.active{color:var(--text);border-color:#2c3f61}
    .search{flex:1;min-width:170px}
    .search input{width:100%;background:var(--soft);border:1px solid #22304a;color:var(--text);padding:8px 10px;border-radius:10px}
    select{background:var(--soft);border:1px solid #22304a;color:var(--text);padding:8px 10px;border-radius:10px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #1f2a3e;padding:8px;text-align:left}
    th{color:var(--muted);font-weight:600}
    tbody tr:hover{background:#121a28}
    .right{text-align:right}
    .debug{margin-top:8px;font-size:12px;color:#8fb4ff;white-space:pre-wrap}
  </style>
</head>
<body>
  <section id="login" class="login">
    <h2 style="margin:0 0 8px 0">Painel de Acompanhamento</h2>
    <div class="f">
      <label for="email">E-mail</label>
      <input id="email" type="email" autocomplete="username" />
      <label for="pass">Senha</label>
      <input id="pass" type="password" autocomplete="current-password" />
      <div class="err" id="err"></div>
      <button id="go" class="btn">Entrar</button>
    </div>
  </section>

  <section id="app" class="app">
    <div class="wrap">
      <header>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <h1>Painel de Acompanhamento</h1>
          <span id="updated" class="muted">Atualizado em —</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="refresh" class="btn">Atualizar</button>
          <button id="logout" class="btn" style="background:#3b3b3b;color:#fff">Sair</button>
        </div>
      </header>

      <div id="cards" class="grid">
        <div class="card highlight" style="grid-column:1 / -1"><div class="k">Valor Total</div><div class="v" id="total">—</div></div>
        <div class="card"><div class="k">Rendimento Total</div><div class="v" id="rtotal">—</div></div>
        <div class="card"><div class="k">Saldo Aplicação CDI</div><div class="v" id="saldo1">—</div></div>
        <div class="card"><div class="k">Rendimento Aplicação CDI</div><div class="v" id="rend1">—</div></div>
        <div class="card"><div class="k">Saldo Conta CDI</div><div class="v" id="saldo2">—</div></div>
        <div class="card"><div class="k">Rendimento Conta CDI</div><div class="v" id="rend2">—</div></div>
      </div>

      <div class="bar" style="gap:10px">
        <label class="muted" for="view">Extrato</label>
        <select id="view">
          <option value="depositos">Depósitos</option>
          <option value="rend1">Rend. Aplicação CDI</option>
          <option value="rend2">Rend. Conta CDI</option>
        </select>
        <div class="pill active" data-range="all">Tudo</div>
        <div class="pill" data-range="30">Últimos 30 dias</div>
        <div class="pill" data-range="90">Últimos 90 dias</div>
        <div class="search"><input id="q" type="search" placeholder="Buscar por detalhe…" /></div>
      </div>

      <div id="t-depositos"></div>
      <div id="t-rend1" style="display:none"></div>
      <div id="t-rend2" style="display:none"></div>

      <div id="dbg" class="debug" style="display:none"></div>
    </div>
  </section>

<script>
(function(){
  const LOGIN_EMAIL='lamounier16@gmail.com';
  const LOGIN_PASS ='helilamounier16';
  const CSV_BASE='https://docs.google.com/spreadsheets/d/e/2PACX-1vSSTZeX26G70f5Xd9WyqZkLE4kjkL4qUUVdpHGras3NWUqjHvRPEY62NB8IzPGpgZmIKbekFDD7gxfg/pub?output=csv&single=true&sheet=';
  const SHEETS={controle:'Controle',depositos:'Depósitos',rend1:'Rendimentos - Investimento 1',rend2:'Rendimentos - Investimento 2'};

  let cutoff=null, dep=[], r1=[], r2=[], booted=false;

  function showLogin(){document.getElementById('login').style.display='block';document.getElementById('app').style.display='none';}
  function showApp(){document.getElementById('login').style.display='none';document.getElementById('app').style.display='block';}
  function saveAuth(){try{localStorage.setItem('pa_auth','1')}catch(e){}}
  function clearAuth(){try{localStorage.removeItem('pa_auth')}catch(e){}}
  function hasAuth(){try{return localStorage.getItem('pa_auth')==='1'}catch(e){return false}}

  function tryLogin(){
    console.log('[tryLogin] fired');
    const e=(document.getElementById('email').value||'').trim().toLowerCase();
    const p=(document.getElementById('pass').value||'').trim();
    if(e===LOGIN_EMAIL.toLowerCase() && p===LOGIN_PASS){
      saveAuth();document.getElementById('err').textContent='';showApp();ensureBoot();
    } else {
      document.getElementById('err').textContent='Credenciais inválidas';
    }
  }

  window.addEventListener('DOMContentLoaded',()=>{
    console.log('[DOMContentLoaded] ready');
    if(hasAuth()){showApp();ensureBoot();}else{showLogin();}
    const go=document.getElementById('go');
    const logout=document.getElementById('logout');
    if(go) go.addEventListener('click',tryLogin);
    if(logout) logout.addEventListener('click',()=>{clearAuth();location.reload();});
    const onEnter=(ev)=>{if(ev.key==='Enter'){tryLogin();}};
    document.getElementById('email').addEventListener('keydown',onEnter);
    document.getElementById('pass').addEventListener('keydown',onEnter);
  });

  function ensureBoot(){ if(!booted){ booted=true; boot(); } }

  async function fetchSheet(sheet){
    const url=CSV_BASE+encodeURIComponent(sheet)+'&ts='+Date.now();
    const res=await fetch(url);
    const txt=await res.text();
    return txt;
  }

  async function boot(force){
    console.log('[boot] loading data...');
    // aqui você chama loadControle, loadDepositos etc.
  }
})();
</script>
</body>
</html>