<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Painel de Saldos</title>
    <meta name="description" content="Interface simples para acompanhar saldos e rendimentos a partir de uma planilha.">
    <style>
      :root{
        --bg:#0f172a;         /* navy/azul marinho */
        --card:#ffffff;
        --muted:#64748b;
        --text:#0f172a;
        --ring:#0ea5e9;
      }
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;background:#f1f5f9;color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";}
      .container{max-width:960px;margin:0 auto;padding:16px}
      .topbar{position:sticky;top:0;z-index:20;background:#ffffffcc;backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid #e2e8f0}
      .row{display:flex;align-items:center;gap:8px}
      .space-between{justify-content:space-between}
      .title{display:flex;align-items:center;gap:8px;font-weight:700}
      .dot{width:8px;height:8px;border-radius:999px;background:#0f172a}
      .btn{appearance:none;border:1px solid #e2e8f0;background:#fff;color:#0f172a;border-radius:10px;padding:8px 12px;cursor:pointer;transition:.2s}
      .btn:hover{background:#f8fafc}
      .btn.primary{background:var(--bg);color:#fff;border-color:#0f172a}
      .btn.ghost{border-color:transparent;background:transparent;color:#0f172a}
      .btn.icon{display:inline-flex;align-items:center;gap:8px}
      .pillbar{display:flex;gap:6px}
      .pill{padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;color:#0f172a;cursor:pointer}
      .pill.active{background:#0f172a;color:#fff;border-color:#0f172a}
      .grid{display:grid;gap:12px}
      @media(min-width:640px){.grid-2{grid-template-columns:1fr 1fr}}
      .card{background:var(--card);border:1px solid #e2e8f0;border-radius:16px;padding:14px}
      .stat{display:flex;align-items:center;gap:12px}
      .stat-title{font-size:12px;color:var(--muted)}
      .stat-value{font-weight:700;font-size:18px}
      .muted{color:var(--muted)}
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:#475569;background:#f8fafc;text-align:left;padding:10px;border-bottom:1px solid #e2e8f0}
      tbody td{padding:10px;border-bottom:1px solid #f1f5f9}
      td.right{text-align:right}
      .section{display:flex;align-items:center;justify-content:space-between;margin:8px 0 10px}
      /* Login */
      .screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
      .login-bg{background:linear-gradient(180deg,#0b1220, #0f172a)}
      .login-card{max-width:380px;width:100%;border:0;box-shadow:0 12px 40px rgba(2,6,23,.35);background:#ffffffee;border-radius:18px;padding:22px}
      .field{display:flex;flex-direction:column;gap:6px}
      .field input{padding:10px 12px;border:1px solid #e2e8f0;border-radius:10px;outline:none}
      .field input:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(14,165,233,.15)}
      .error{color:#b91c1c;font-size:12px}
      .toolbar{display:flex;gap:8px;flex-wrap:wrap}
      select{padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
      #app{display:none}
      .hidden{display:none !important}
      /* Debug panel */
      #debug{display:none;margin-top:8px}
      #dbg-pre{max-height:220px;overflow:auto;background:#0b1220;color:#e5e7eb;border-radius:10px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
      .ok{color:#16a34a} .bad{color:#b91c1c}
      .inline-muted{color:#64748b;font-size:12px}
      .hint{font-size:12px;color:#334155}
    </style>
  </head>
  <body>
    <!-- LOGIN -->
    <section id="login" class="screen login-bg">
      <div class="login-card">
        <div class="row" style="gap:10px;margin-bottom:8px">
          <div class="dot"></div>
          <div style="font-weight:700;color:#0f172a">Acesso</div>
        </div>
        <div class="field"><label>Email</label><input id="email" inputmode="email" placeholder="seu@email.com"></div>
        <div class="field" style="margin-top:10px">
          <label>Senha</label>
          <div class="row"><input id="pass" type="password" placeholder="••••••••" style="flex:1"><label class="hint"><input id="showpass" type="checkbox" style="margin-right:6px">mostrar</label></div>
        </div>
        <div id="err" class="error" style="min-height:18px;margin-top:6px"></div>
        <div class="row" style="gap:8px;margin-top:6px">
          <button id="go" class="btn primary" style="flex:1">Entrar</button>
          <button id="autofill" class="btn" title="Preencher credenciais">Autopreencher</button>
        </div>
        <div class="muted" style="font-size:12px;margin-top:10px">Login simples para acesso básico.</div>
      </div>
    </section>

    <!-- APP -->
    <div id="app">
      <div class="topbar">
        <div class="container row space-between" style="padding:10px 16px">
          <div class="title"><div class="dot"></div> <span>Painel de Saldos</span></div>
          <div class="toolbar">
            <select id="view" title="Escolher visão">
              <option value="depositos">Depósitos</option>
              <option value="rend1">Rendimentos – Investimento 1</option>
              <option value="rend2">Rendimentos – Investimento 2</option>
            </select>
            <div class="pillbar">
              <button class="pill active" data-range="all">Todo período</button>
              <button class="pill" data-range="90">90 dias</button>
              <button class="pill" data-range="30">30 dias</button>
            </div>
            <button id="refresh" class="btn icon" title="Atualizar agora">↻ Atualizar</button>
            <button id="toggle-debug" class="btn">Debug</button>
            <button id="logout" class="btn ghost">Sair</button>
          </div>
        </div>
      </div>

      <main class="container" style="padding-top:14px">
        <div class="row space-between" style="margin-bottom:8px">
          <div>
            <div class="muted" style="font-size:12px">Última atualização</div>
            <div id="updated" style="font-weight:600">—</div>
          </div>
        </div>

        <!-- CARDS -->
        <div class="grid grid-2" style="margin:10px 0 14px">
          <div class="card"><div class="stat"><div class="stat-title">Aplicação 1</div><div id="saldo1" class="stat-value">—</div></div></div>
          <div class="card"><div class="stat"><div class="stat-title">Aplicação 2</div><div id="saldo2" class="stat-value">—</div></div></div>
          <div class="card"><div class="stat"><div class="stat-title">Valor total</div><div id="total" class="stat-value">—</div></div></div>
          <div class="card"><div class="stat"><div class="stat-title">Rendimento acumulado — Aplicação 1</div><div id="rend1" class="stat-value">—</div></div></div>
          <div class="card"><div class="stat"><div class="stat-title">Rendimento acumulado — Aplicação 2</div><div id="rend2" class="stat-value">—</div></div></div>
          <div class="card"><div class="stat"><div class="stat-title">Rendimento acumulado total</div><div id="rtotal" class="stat-value">—</div></div></div>
        </div>

        <!-- TABELAS -->
        <div class="section"><div class="muted" style="text-transform:uppercase;letter-spacing:.06em;font-size:12px">Extratos</div></div>
        <div id="t-depositos"></div>
        <div id="t-rend1" class="hidden"></div>
        <div id="t-rend2" class="hidden"></div>

        <!-- DEBUG PANEL -->
        <div id="debug" class="container">
          <div class="card">
            <div class="row space-between" style="margin-bottom:6px">
              <strong>Diagnóstico</strong>
              <div class="row" style="gap:6px">
                <button id="diag-run" class="btn">Rodar diagnóstico</button>
                <button id="diag-clear-auth" class="btn">Limpar login</button>
              </div>
            </div>
            <div class="hint" style="margin-bottom:6px">Use <span class="inline-muted">?debug=1</span> na URL para abrir este painel automaticamente.</div>
            <ul id="diag-status" class="muted" style="padding-left:18px"></ul>
            <pre id="dbg-pre"></pre>
          </div>
        </div>
      </main>
    </div>

    <script>
(function(){
  // ====== DEBUG infra ======
  const initialDebug = /[?&]debug=1/.test(location.search) || (localStorage.getItem('pa_debug')==='1');
  window.DEBUG = initialDebug;
  const LOGS = [];
  function log(){
    const msg = Array.from(arguments).map(x=> (typeof x==='object'? JSON.stringify(x): String(x))).join(' ');
    LOGS.push({t:new Date(), msg});
    if(window.DEBUG) console.log('[APP]', msg);
    const pre = document.getElementById('dbg-pre');
    if(pre){
      pre.textContent = LOGS.map(l=>`[${l.t.toLocaleTimeString('pt-BR')}] ${l.msg}`).join('\\n');
      pre.scrollTop = pre.scrollHeight;
    }
  }
  function setDebug(v){
    window.DEBUG = !!v;
    localStorage.setItem('pa_debug', v? '1':'0');
    document.getElementById('debug').style.display = v? 'block':'none';
    document.getElementById('toggle-debug').classList.toggle('primary', v);
  }

  // ====== LOGIN (hardcoded, simples) ======
  const LOGIN_EMAIL='lamounier16@gmail.com';
  const LOGIN_PASS ='helilamounier16';

  // ====== PLANILHA PUBLICADA (CSV por aba) ======
  const CSV_BASE='https://docs.google.com/spreadsheets/d/e/2PACX-1vSSTZeX26G70f5Xd9WyqZkLE4kjkL4qUUVdpHGras3NWUqjHvRPEY62NB8IzPGpgZmIKbekFDD7gxfg/pub?output=csv&single=true&sheet=';
  const SHEETS={
    controle:'Controle',
    depositos:'Depósitos',
    rend1:'Rendimentos - Investimento 1',
    rend2:'Rendimentos - Investimento 2'
  };

  let cutoff=null, dep=[], r1=[], r2=[], booted=false;
  const $=s=>document.querySelector(s);
  const $$=s=>document.querySelectorAll(s);

  function showLogin(){$('#login').style.display='block';$('#app').style.display='none';}
  function showApp(){$('#login').style.display='none';$('#app').style.display='block';}

  function saveAuth(){try{localStorage.setItem('pa_auth','1')}catch(e){}}
  function clearAuth(){try{localStorage.removeItem('pa_auth')}catch(e){}}
  function hasAuth(){try{return localStorage.getItem('pa_auth')==='1'}catch(e){return false}}

  window.addEventListener('DOMContentLoaded',()=>{
    setDebug(initialDebug);
    if(hasAuth()){showApp();ensureBoot();}else{showLogin();}
    const onEnter=(ev)=>{ if(ev.key==='Enter'){ tryLogin(); } };
    $('#email').addEventListener('keydown',onEnter);
    $('#pass').addEventListener('keydown',onEnter);
    $('#showpass').addEventListener('change', (e)=> { $('#pass').type = e.target.checked? 'text':'password'; });
    $('#autofill').addEventListener('click', ()=> { $('#email').value = LOGIN_EMAIL; $('#pass').value = LOGIN_PASS; });
    $('#toggle-debug').addEventListener('click', ()=> setDebug(!window.DEBUG));
    $('#diag-clear-auth').addEventListener('click', ()=> { clearAuth(); alert('Login limpo. Recarregue e entre novamente.'); });
    $('#diag-run').addEventListener('click', runDiagnostics);
  });

  function tryLogin(){
    const e=($('#email').value||'').trim().toLowerCase();
    const p=($('#pass').value||'').trim();
    log('Tentando login com', e? ('email:'+e): 'email:vazio');
    if(!e){ $('#err').textContent='Informe o email.'; return; }
    if(!p){ $('#err').textContent='Informe a senha.'; return; }
    if(e!==LOGIN_EMAIL.toLowerCase()){
      $('#err').textContent='Email diferente do cadastrado.';
      log('Falha: email não confere');
      return;
    }
    if(p!==LOGIN_PASS){
      $('#err').textContent='Senha incorreta.';
      log('Falha: senha não confere');
      return;
    }
    saveAuth();
    $('#err').textContent='';
    log('Login OK');
    showApp();
    ensureBoot();
  }

  $('#go').addEventListener('click',tryLogin);
  $('#logout').addEventListener('click',()=>{clearAuth();location.reload();});

  function ensureBoot(){ if(!booted){ booted=true; boot().catch(err=>{ log('Erro no boot:', err); }); } }

  // ====== CSV helpers ======
  function parseCSV(text){
    const lines=text.replace(/\\r/g,'').split(/\\n+/).filter(Boolean);
    const rows=lines.map(line=>{
      const out=[];let cur='';let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){
          if(q && line[i+1]==='"'){cur+='"';i++;} else {q=!q;}
        } else if(ch===',' && !q){
          out.push(cur);cur='';
        } else {
          cur+=ch;
        }
      }
      out.push(cur);
      return out;
    });
    const cols=rows.shift()||[];
    return{cols,rows};
  }
  async function fetchSheet(sheet){
    const url=CSV_BASE+encodeURIComponent(sheet)+'&ts='+Date.now();
    log('GET', url);
    const res=await fetch(url);
    if(!res.ok){ throw new Error('HTTP '+res.status+' ao buscar '+sheet); }
    const txt=await res.text();
    return parseCSV(txt);
  }

  // ====== util ======
  const norm=s=>(s||'').toString().normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').toLowerCase().trim().replace(/\\s+/g,' ');
  const findIndex=(cols,cands)=>{const C=cols.map(norm);for(const c of cands){const i=C.indexOf(norm(c));if(i>=0)return i;}return -1;};
  function toDate(s){
    if(!s) return null;
    if(s instanceof Date) return s;
    if(typeof s==='string'){
      s = s.replace(/\\u00A0/g,' ').trim(); // remove NBSP
      const only = s.split(' ')[0];
      const m = only.match(/^(\\d{1,2})[\\/-](\\d{1,2})[\\/-](\\d{2,4})$/);
      if(m){
        const dd=+m[1], mm=+m[2]-1, yy=(+m[3]<100?2000+(+m[3]):+m[3]);
        return new Date(yy,mm,dd);
      }
    }
    return null;
  }
  function fmtBRL(n){
    if(n==null||n==='') return '—';
    const num=parseFloat(String(n).replace(/[^0-9\\-.,]/g,'').replace(/\\./g,'').replace(',', '.'));
    if(isNaN(num)) return String(n);
    return num.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }
  function fmtDate(d){
    if(!(d instanceof Date)||isNaN(d)) return '—';
    const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yy=d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }
  function escapeHTML(s){ return String(s).replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  // ====== CONTROLE (cards) ======
  async function loadControle(){
    log('loadControle…');
    const g=await fetchSheet(SHEETS.controle);
    log('controle: linhas', g.rows.length);
    if(!g.rows.length) return;
    const c=g.cols, r=g.rows[0];
    const ix={
      data:findIndex(c,['data']),
      aplic1:findIndex(c,['aplicação 1','aplicacao 1']),
      rend1:findIndex(c,['rendimento 1']),
      aplic2:findIndex(c,['aplicação 2','aplicacao 2']),
      rend2:findIndex(c,['rendimento 2']),
      total:findIndex(c,['total']),
      rtotal:findIndex(c,['rendimento total'])
    };
    const dA2=toDate(r[ix.data]);
    cutoff=dA2||new Date();
    $('#total').textContent=fmtBRL(r[ix.total]);
    $('#rtotal').textContent=fmtBRL(r[ix.rtotal]);
    $('#saldo1').textContent=fmtBRL(r[ix.aplic1]);
    $('#rend1').textContent=fmtBRL(r[ix.rend1]);
    $('#saldo2').textContent=fmtBRL(r[ix.aplic2]);
    $('#rend2').textContent=fmtBRL(r[ix.rend2]);
    $('#updated').textContent='Atualizado em '+fmtDate(dA2);
  }

  // ====== DEPÓSITOS ======
  async function loadDepositos(){
    log('loadDepositos…');
    const g=await fetchSheet(SHEETS.depositos);
    log('dep: linhas', g.rows.length);
    if(!g.rows.length){dep=[];return;}
    const c=g.cols; const ix={data:findIndex(c,['data']),valor:findIndex(c,['depósito','deposito']),detalhe:findIndex(c,['detalhe'])};
    dep=g.rows.map(r=>({data:toDate(r[ix.data]),valor:r[ix.valor],det: ix.detalhe>=0?(r[ix.detalhe]||''):''}))
              .filter(x=>x.data && x.data<=cutoff);
  }

  // ====== RENDIMENTOS — APENAS DATA E VALOR ======
  async function loadRend1(){
    log('loadRend1…');
    const g=await fetchSheet(SHEETS.rend1);
    log('rend1: linhas', g.rows.length);
    if(!g.rows.length){r1=[];return;}
    const c=g.cols; const ix={data:findIndex(c,['data']),valor:findIndex(c,['rendimento'])};
    r1=g.rows.map(r=>({data:toDate(r[ix.data]),valor:r[ix.valor]})).filter(x=>x.data);
  }
  async function loadRend2(){
    log('loadRend2…');
    const g=await fetchSheet(SHEETS.rend2);
    log('rend2: linhas', g.rows.length);
    if(!g.rows.length){r2=[];return;}
    const c=g.cols; const ix={data:findIndex(c,['data']),valor:findIndex(c,['rendimento'])};
    r2=g.rows.map(r=>({data:toDate(r[ix.data]),valor:r[ix.valor]})).filter(x=>x.data);
  }

  // ====== Render ======
  function tableHTML(headers, rows){
    if(!rows.length) return '<div class="card"><span class="muted">Sem lançamentos no período.</span></div>';
    const thead='<thead><tr>'+headers.map(h=>'<th>'+h+'</th>').join('')+'</tr></thead>';
    const tbody='<tbody>'+rows.map(r=>'<tr>'+r.map((c,i)=>'<td class="'+(i>0?'right':'')+'">'+c+'</td>').join('')+'</tr>').join('')+'</tbody>';
    return '<div class="card"><table>'+thead+tbody+'</table></div>';
  }

  function renderTables(){
    const range=$('.pill.active').dataset.range;
    const view=$('#view').value;
    function inRange(d){
      if(!d||!cutoff) return false;
      if(range==='all') return d<=cutoff;
      const days=(range==='30'?30:90);
      const from=new Date(cutoff); from.setDate(from.getDate()-days);
      return d>=from && d<=cutoff;
    }
    const depRows = dep.filter(x=>inRange(x.data)).map(x=>[fmtDate(x.data), fmtBRL(x.valor), escapeHTML(x.det)]);
    const r1Rows  = r1.filter(x=>inRange(x.data)).map(x=>[fmtDate(x.data), fmtBRL(x.valor)]);
    const r2Rows  = r2.filter(x=>inRange(x.data)).map(x=>[fmtDate(x.data), fmtBRL(x.valor)]);

    let rowsForView = view==='depositos'?depRows : view==='rend1'?r1Rows : r2Rows;
    if(range!=='all' && rowsForView.length===0){
      $$('.pill').forEach(x=>x.classList.remove('active'));
      $('.pill[data-range="all"]').classList.add('active');
      return renderTables();
    }

    $('#t-depositos').classList.toggle('hidden', view!=='depositos');
    $('#t-rend1').classList.toggle('hidden', view!=='rend1');
    $('#t-rend2').classList.toggle('hidden', view!=='rend2');

    $('#t-depositos').innerHTML = tableHTML(['Data','Valor','Detalhe'], depRows);
    $('#t-rend1').innerHTML     = tableHTML(['Data','Rendimento'], r1Rows);
    $('#t-rend2').innerHTML     = tableHTML(['Data','Rendimento'], r2Rows);
  }

  // ====== Interações ======
  $$('.pill').forEach(p=> p.addEventListener('click',()=>{
    $$('.pill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active'); renderTables();
  }));
  $('#view').addEventListener('change',renderTables);
  $('#refresh').addEventListener('click',()=>boot(true));

  // ====== Boot ======
  async function boot(force){
    try{
      log('Boot iniciado');
      await loadControle();
      await Promise.all([loadDepositos(),loadRend1(),loadRend2()]);
      if(!force){
        $('#view').value='depositos';
        $$('.pill').forEach(x=>x.classList.remove('active'));
        $('.pill[data-range="all"]').classList.add('active');
      }
      renderTables();
      log('Boot concluído');
    }catch(err){
      log('Boot falhou:', err.message||String(err));
      const ul=document.getElementById('diag-status');
      if(ul){ ul.innerHTML += `<li class="bad">Erro no boot: ${escapeHTML(err.message||String(err))}</li>`; }
    }
  }

  // ====== Diagnostics ======
  async function runDiagnostics(){
    const ul=document.getElementById('diag-status');
    ul.innerHTML='';
    function add(li, ok){ ul.innerHTML += `<li class="${ok?'ok':'bad'}">${li}</li>`; }
    try{
      add('Iniciando diagnóstico…', true);
      // Ping nas 4 abas
      for(const [key,name] of Object.entries(SHEETS)){
        try{
          const g = await fetchSheet(name);
          add(`Aba “${name}”: OK (${g.rows.length} linhas)`, true);
        }catch(e){
          add(`Aba “${name}”: ERRO — ${escapeHTML(e.message||String(e))}`, false);
        }
      }
      // Check sessão
      add('Sessão: '+(hasAuth()? 'logado':'não logado'), hasAuth());
      add('Data de corte (Controle): '+(cutoff? cutoff.toLocaleDateString('pt-BR'):'—'), !!cutoff);
      log('Diagnóstico finalizado');
    }catch(e){
      add('Diagnóstico falhou: '+escapeHTML(e.message||String(e)), false);
    }
  }

})();</script>
  </body>
</html>